# 35.5 折叠表达式

在前面的例子中，我们提到了利用数组和递归的方式对形参包进行计算的方法。这些都是非常实用的技巧，解决了C++11标准中包展开方法并不丰富的问题。不过实话实说，递归计算的方式过于烦琐，数组和括号表达式的方法技巧性太强也不是很容易想到。为了用更加正规的方法完成包展开，C++委员会在C++17标准中引入了折叠表达式的新特性。让我们使用折叠表达式的特性改写递归的例子：

```cpp
include<iostream>   
template<class...Args>   
auto sum(Args ...args)   
{ return(args  $^+$  ...);   
}   
int main()   
{ std::cout<<sum(1，5.0，11.7）<<std::endl;   
}
```

如果读者是第一次接触折叠表达式，一定会为以上代码的简洁感到惊叹。在这份代码中，我们不再需要编写多个sum函数，然后通过

递归的方式求和。需要做的只是按照折叠表达式的规则折叠形参包(args +...）。根据折叠表达式的规则，(args +...）会被折叠为arg0 + (arg1 + arg2)，即  $1 + (5.0 + 11.7)$ 。

到此为止，读者应该已经迫不及待地想了解折叠表达式的折叠规则了吧。那么接下来我们就来详细地讨论折叠表达式的折叠规则。

在C++17的标准中有4种折叠规则，分别是一元向左折叠、一元向右折叠、二元向左折叠和二元向右折叠。上面的例子就是一个典型的一元向右折叠：

```lisp
(args op ... )折叠为(arg0 op (arg1 op ... (argN-1 op argN)))
```

对于一元向左折叠而言，折叠方向正好相反：

```txt
( ... op args )折叠为 (((arg0 op arg1) op arg2) op ... ) op argN)
```

二元折叠总体上和一元相同，唯一的区别是多了一个初始值，比如二元向右折叠：

```clojure
(args op ... op init)折叠为(arg0 op (arg1 op ... (argN-1 op (argN op init))))
```

二元向左折叠也是只有方向上正好相反:

```txt
( init op ... op args )折叠为 (((init op arg0) op arg1) op arg2) op... ) op argN)
```

虽然没有提前声明以上各部分元素的含义，但是读者也能大概看明白其中的意思。这其中，args表示的是形参包的名称，init表示

的是初始化值，而op则代表任意一个二元运算符。值得注意的是，在二元折叠中，两个运算符必须相同

在折叠规则中最重要的一点就是操作数之间的结合顺序。如果在使用折叠表达式的时候不能清楚地区分它们，可能会造成编译失败，例如：

```cpp
include<iostream> #include<string> template<class...Args> auto sum(Args ...args) { return(args + ...); } int main() { std::cout << sum(std::string("hello"), "c++ ", "world") << std::endl; //编译错误 }
```

上面的代码会编译失败，理由很简单，因为折叠表达式(args + ...)向右折叠，所以翻译出来的实际代码是(std::string("hello") + ("c++ " + "world"))。但是两个原生的字符串类型是无法相加的，所以编译一定会报错。要使这段代码通过编译，只需要修改一下折叠表达式即可：

```txt
template<class...Args> auto sum(Args ...args) {
    return (... + args);
}
```

这样翻译出来的代码将是((std::string("hello ") + "c++ ") + "world")。而std::string类型的字符串可以使用+将两个字符串连接起来，于是可以顺利地通过编译。

最后让我们来看一个有初始化值的例子：

```cpp
include<iostream>   
#include <string>   
template<class ...Args>   
void print(Args ...args)   
{ (std::cout << ... << args) << std::endl;   
}   
int main()   
{ print(std::string("hello"), "c++ ", "world");
```

在上面的代码中，print是一个输出函数，它会将传入的实参输出到控制台上。该函数运用了二元向左折叠(std::cout <<...<<args)，其中std::cout是初始化值，编译器会将代码翻译为

```cpp
((std::cout << std::string("hello")) << "c++")
<< "world") << std::endl;。
```

