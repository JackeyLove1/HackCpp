# 30.1 不可忽视的数据对齐问题

C++11中新增了alignof和 Alignas两个关键字，其中 alignof 运算符可以用于获取类型的对齐字节长度，alignas 说明符可以用来改变类型的默认对齐字节长度。这两个关键字的出现解决了长期以来 C++标准中无法对数据对齐进行处理的问题。

在详细介绍这两个关键字之前，我们先来看一看下面这段代码：

```cpp
include<iostream>   
struct A { char a1; int a2; double a3; }；   
struct B { short b1; bool b2; double b3; }；   
int main() { std::cout << "sizeof(A::a1) + sizeof(A::a2) + sizeof(A::a3) = " << sizeof(A::a1) + sizeof(A::a2) + sizeof(A::a3) << std::endl; std::cout << "sizeof(B::b1) + sizeof(B::b2) + sizeof(B::b3) = "
```

```cpp
<< sizeof(B::b1) + sizeof(B::b2) + sizeof(B::b3) << std::endl;  
std::cout << "sizeof(A) = " << sizeof(A) << std::endl;  
std::cout << "sizeof(B) = " << sizeof(B) << std::endl;
```

# 编译运行这段代码会得到以下结果:

```txt
sizeof(A::a1) + sizeof(A::a2) + sizeof(A::a3) = 13  
sizeof(B::b1) + sizeof(B::b2) + sizeof(B::b3) = 11  
sizeof(A) = 16  
sizeof(B) = 16
```

奇怪的事情发生了，A和B两个类的成员变量的数据长度之和分别为13字节和11字节，与它们本身的数据长度16字节不同。对比这两个类，它们在成员变量数据长度之和上明明不同，却在类整体数据长度上又相同。有经验的程序员应该一眼就能看出其中的原因。实际上，一个类型的属性除了其数据长度，还有一个重要的属性——数据对齐的字节长度。

在上面的代码中，char以1字节对齐，short以2字节对齐，int以4字节对齐，double以8字节对齐，所以它们的实际数据结构应该是这样的：

```txt
struct A
{
    char a1;
    char a1_pad[3];
    int a2;
    double a3;
};
```

内存布局如表30-1所示。

▼表30-1  

<table><tr><td>偏移量</td><td>元素</td></tr><tr><td>0x0000</td><td>a1</td></tr><tr><td>0x0001</td><td>a1_pad[3]</td></tr><tr><td>0x0004</td><td>a2</td></tr><tr><td>0x0008</td><td>a3</td></tr></table>

```c
struct B
{
    short b1;
    bool b2;
    char b2_pad[5];
    double b3;
};
```

内存布局如表30-2所示。

▼表30-2  

<table><tr><td>偏移量</td><td>元素</td></tr><tr><td>0x0000</td><td>b1</td></tr><tr><td>0x0002</td><td>b2</td></tr><tr><td>0x0003</td><td>b2_pad[5]</td></tr><tr><td>0x0008</td><td>b3</td></tr></table>

通过上述示例应该能够对数据对齐有比较直观的理解了。但是为什么我们需要数据对齐呢？原因说起来很简单，就是硬件需要。首当其冲的就是CPU了，CPU对数据对齐有着迫切的需求，一个好的对齐字节长度可以让CPU运行起来更加轻松快速。反过来说，不好的对齐字节长度则会让CPU运行速度减慢，甚至抛出错误。通常来说所谓好的对齐长度和CPU访问数据总线的宽度有关系，比如CPU访问32位宽度的数据总线，就会期待数据是按照32位对齐，也就是4字节。这样CPU读取4字节的数据只需要对总线访问一次，但是如果要访问的数据并没有按照4字节对齐，那么CPU需要访问数据总线两次，运算速度自然也就减慢了。另外，对于数据对齐问题引发错误的情况（Alignment Fault），通常会发生在ARM架构的计算机上。当然除了CPU之外，还有其他硬件也需要数据对齐，比如通过DMA访问硬盘，就会要求内存必须是4K对齐的。总的来说，配合现代编译器和CPU架构，可以让程序获得令人难以置信的性能，但这种良好的性能取决于某些编程实践，其中一种编程实践是正确的数据对齐。

