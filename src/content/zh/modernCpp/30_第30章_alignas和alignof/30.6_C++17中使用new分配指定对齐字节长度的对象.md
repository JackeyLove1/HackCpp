# 30.6 C++17中使用new分配指定对齐字节长度的对象

前面曾提到过内存分配器会按照std::max_align_t的对齐字节长度分配对象的内存空间。这一点在C++17标准中发生了改变，new运算符也拥有了根据对齐字节长度分配对象的能力。这个能力是通过让new运算符接受一个std::align_val_t类型的参数来获得分配对象需要的对齐字节长度来实现的：

```cpp
void\* operator new(std::size_t，std::align_val_t); void\* operator new[] (std::size_t，std::align_val_t);
```

编译器会自动从类型对齐字节长度的属性中获取这个参数并且传参，不需要额外的代码介入。例如：

```cpp
// test_new.cpp   
#include<iostream>   
union alignas(256)X   
{ char a1; int a2; double a3;   
}； int main(int argc，char \*argv[]) { X \*x = new X(); std::cout << "x = " << x << std::endl;   
}
```

通过GCC编译器将其编译为C++11和C++17两个版本，可以看到输出结果的区别：

```txt
g++ -std=c++11 test_new.cpp -o cpp11 ./cpp11   
 $\mathrm{x} = 0\mathrm{x}1071620$    
g++ -std=c++17 test_new.cpp -o cpp17 ./cpp17   
 $\mathrm{x} = 0\mathrm{x}1\mathrm{d}1700$
```

我们发现在使用C++11标准的情况下，new分配的对象指针（0x1071620）并没有按照x指定的对齐字节长度（256字节）对齐，而在使用C++17标准的情况下，new分配的对象指针（0x1d1700）正好为x指定的对齐字节长度。

