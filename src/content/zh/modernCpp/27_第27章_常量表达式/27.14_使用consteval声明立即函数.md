# 27.14 使用consteval声明立即函数

前面我们曾提到过，constexpr声明函数时并不依赖常量表达式上下文环境，在非常量表达式的环境中，函数可以表现为普通函数。不过有时候，我们希望确保函数在编译期就执行计算，对于无法在编译期执行计算的情况则让编译器直接报错。于是在C++20标准中出现了一个新的概念——立即函数，该函数需要使用consteval说明符来声明：

```javascript
consteval int sqr(int n) {
    return n * n;
}
constexpr int r = sqr(100); // 编译成功
int x = 100;
int r2 = sqr(x); // 编译失败
```

在上面的代码中sqr(100); 是一个常量表达式上下文环境，可以编译成功。相反，因为sqr(x); 中的x是可变量，不能作为常量表达式，所以编译器抛出错误。要让代码成功编译，只需要给x加上const即可。需要注意的是，如果一个立即函数在另外一个立即函数中被调用，则函数定义时的上下文环境不必是一个常量表达式，例如：

```javascript
consteval int sqr(sqr(int n) {
    return sqr(sqr(n));
}
```

sqrsqr是否能编译成功取决于如何调用，如果调用时处于一个常量表达式环境，那么就能通过编译：

```txt
int y = sqrsqrt(100);
```

反之则编译失败:

```txt
int y = sqrsqrt(x);
```

lambda表达式也可以使用consteval说明符:

```javascript
auto sqr = []; (int n) consteval { return n * n; }; int r = sqr(100);
```

```txt
auto f = sqr; // 编译失败，尝试获取立即函数的函数地址
```

